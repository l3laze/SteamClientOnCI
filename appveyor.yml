# Build with NodeJS v# using architecture-specific instalallations
environment:
  yarn_version: '1.9.4'
  matrix:
    - nodejs_version: 8

# Build using both 32-bit and 64-bit Windows.
platform:
  - x64
#  - x86

# Because of this:
#   https://help.github.com/articles/dealing-with-line-endings/
init:
  - git config --global core.autocrlf input

install:
  - ps: Install-Product node $env:nodejs_version $env:Platform
  - npm i -g npm
  - ps: Write-Host "Installing Yarn..."
  - ps: (New-Object Net.WebClient).DownloadFile('https://github.com/yarnpkg/yarn/releases/download/v' + $env:yarn_version + '/yarn-' + $env:yarn_version + '.msi', "$env:temp\yarn-" + $env:yarn_version + ".msi")
  - ps: cmd /c start /wait msiexec.exe /i $env:temp\yarn-$env:yarn_version.msi /quiet
  - yarn --version
  - yarn

  - ps: if ((Test-Path -path "C:\\Program Files (x86)\\Steam") -ne $True) { `
        Write-Host "Installing Steam..." `
        (New-Object Net.WebClient).DownloadFile('http://steamcdn-a.akamaihd.net/client/installer/SteamSetup.exe', $env:temp + '\SteamSetup.exe') `
      }
  - ps: if (not exist "C:\\Program Files (x86)\\Steam") { `
        "!temp!\\SteamSetup.exe" /S /v /qb `
        timeout 10 `
        taskkill.exe /F /T /IM Steam* || ( cmd /c "exit /b 0" ) `
        powershell Start-Process -FilePath "C:\\Program Files (x86)\\Steam\\Steam.exe" -NoNewWindow `
        timeout 60 `
        taskkill.exe /F /T /IM steam* || ( cmd /c "exit /b 0" ) `
        echo "Installed Steam" `
      }
  - ps: Start-Process -FilePath "C:\\Program Files (x86)\\Steam\\Steam.exe" -ArgumentList @("-login", $env:steamu, $env:steamp) -NoNewWindow
  - timeout 60
  - ps: Start-Process -FilePath "C:\\Program Files (x86)\\Steam\\Steam.exe" -ArgumentList @("-shutdown") -NoNewWindow
  - timeout 10
  - taskkill.exe /F /T /IM steam* || ( cmd /c "exit /b 0" )
  - dir "C:\Program Files (x86)\Steam"
  - cd "%APPVEYOR_BUILD_FOLDER%"

# Cache some dirs for faster build.
cache:
  - "%LOCALAPPDATA%\\Yarn"
  - "C:\\Program Files (x86)\\Steam"


# Quiet-ish build.
build:
  verbosity: minimal


# Run build (tests)
build_script:
  - yarn lint && yarn test "C:\Program Files (x86)\Steam"

# Store snapshot
artifacts:
  - path: .\snapshot.json
    name: snapshot.json
    type: File